- name: Configure Ubuntu for ROCm
  hosts: all
  become: yes
  # vars:
  #   rocm_version: "5.7.3"
  #   amdgpu_install_version: "5.7.50703-1"

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install basic packages
      apt:
        name:
          - vim
          - zsh
          - qemu-guest-agent
          - build-essential
          - python3
          - python3-pip
          - git
          - wget
          - gpg
        state: present

  roles:
    - role: rocm-install

  post_tasks:
  # --- Настройка сети ---
  - name: Configure static network for enp1s0
    copy:
      content: |
        # Configured by Packer/Ansible (do not edit manually)
        network:
          version: 2
          ethernets:
            enp1s0:
              addresses:
                - {{ static_ip }}/24
              routes:
                - to: default
                  via: {{ gateway }}
              nameservers:
                addresses:
                  - {{ dns_servers }}
      dest: /etc/netplan/01-static-network.yaml
      mode: '0644'
      owner: root
      group: root

  # --- Запретить vfio-pci (чтобы amdgpu мог взять GPU) ---
  - name: Blacklist vfio-pci to allow amdgpu to control the GPU
    copy:
      content: |
        # Blacklist vfio-pci to prevent it from claiming AMD GPU
        blacklist vfio-pci
      dest: /etc/modprobe.d/blacklist-vfio-pci.conf
      mode: '0644'
      owner: root
      group: root

  # --- Убедиться, что amdgpu загружается при старте ---
  - name: Ensure amdgpu is in /etc/modules
    lineinfile:
      path: /etc/modules
      line: amdgpu
      state: present

  # --- Обновить initramfs, чтобы включить amdgpu и blacklist ---
  - name: Update initramfs to include amdgpu and blacklist vfio-pci
    command: update-initramfs -u

  # --- Очистка кэша APT ---
  - name: Clean up apt cache
    apt:
      autoclean: yes
      autoremove: yes
    tags: cleanup
